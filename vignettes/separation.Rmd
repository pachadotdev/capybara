---
title: "Nonexistence of estimates of Poisson models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Nonexistence of estimates of Poisson models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette is adapted from https://github.com/sergiocorreia/ppmlhdfe/blob/master/guides/nonexistence_benchmarks.md#r-packages.

## Example 1

```{r setup}
library(capybara)
```

The table below shows a dataset with 12 observations and four regressors. Observations 5 is separated
because $y=0$ and $z \neq x_2 - x_1$ is positive in those observations, and zero otherwise.

```{r example1-data}
ppmlhdfe$example1
which(ppmlhdfe$example1$x2 - ppmlhdfe$example1$x1 != 0 & ppmlhdfe$example1$y == 0)
```

Base R shall not give a warning when estimating a Poisson model on this data.

```{r example1-glm}
glm(
  y ~ x1 + x2 + x3 + x4,
  data = ppmlhdfe$example1,
  family = poisson()
)
```

Capybara will detect separation on this dataset.

```{r example1-fepoisson}
fepoisson(
  y ~ x1 + x2 + x3 + x4,
  data = ppmlhdfe$example1
)
```

## Example 2

The table below shows a different dataset with 12 observations and four regressors. Observations 2, 3, 6, 7 and 8 are
separated because $y=0$ and $z > x_2 - x_1$ is positive in those observations, and zero otherwise.

```{r example2-data}
ppmlhdfe$example2
which(ppmlhdfe$example2$x2 - ppmlhdfe$example2$x1 > 0 & ppmlhdfe$example2$y == 0)
```

Base R shall give a convergence warning when estimating a Poisson model on this data.

```{r example2-glm, warning=TRUE}
glm(
  y ~ x1 + x2 + x3 + x4,
  data = ppmlhdfe$example2,
  family = poisson()
)
```

Capybara will detect separation on this dataset.

```{r example2-fepoisson}
fepoisson(
  y ~ x1 + x2 + x3 + x4,
  data = ppmlhdfe$example2
)
```

## Example 3 (fixed effects)

Base R shall not give a warning when estimating a Poisson model with fixed effects on the dataset below. The separation
in this case is less clear, which motivates why capybara uses linear programming to detect separation in Poisson models.

```{r fe1-data}
ppmlhdfe$fe1
```

Base R shall not give a warning when estimating a Poisson model with fixed effects on this data.

```{r fe1-glm}
glm(
  y ~ x1 + x2 + factor(i) + factor(j),
  data = ppmlhdfe$fe1,
  family = poisson()
)
```

Capybara will detect separation when estimating Poisson models.

```{r fe1-capybara}
fepoisson(
  y ~ x1 + x2 | i + j,
  data = ppmlhdfe$fe1
)
```

'ppmlhdfe' will also detect separation when estimating Poisson models with fixed effects.

```stata
. ppmlhdfe y x1 x2, a(i j)
(simplex method dropped 4 separated observations)
(dropped 1 singleton observations)
note: 1 variable omitted because of collinearity: x2
 $$ Stopping (no negative residuals); separation found in 0 observations (1 iterations and 732 subiterations)
Iteration 1:   deviance = 1.4149e+01  eps = .         iters = 4    tol = 1.0e-04                                                                            
...
Iteration 6:   deviance = 1.3364e+01  eps = 1.85e-16  iters = 3    tol = 1.0e-07                                                                            
-------------------------------------------------------------------------------
(legend: p: exact partial-out   s: exact solver   h: step-halving   o: epsilon 
> below tolerance)
Converged in 6 iterations and 21 HDFE sub-iterations (tol = 1.0e-08)

HDFE PPML regression                              No. of obs      =         13
Absorbing 2 HDFE groups                           Residual df     =          7
                                                  Wald chi2(1)    =       0.53
Deviance             =  13.36443052               Prob > chi2     =     0.4686
Log pseudolikelihood =  -11.2959209               Pseudo R2       =     0.0607
------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          x1 |  -.4845469   .6685201    -0.72   0.469    -1.794822    .8257284
          x2 |          0  (omitted)
       _cons |  -.5708466   .4604099    -1.24   0.215    -1.473233    .3315402
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
           i |         3           0           3     |
           j |         3           1           2     |
-----------------------------------------------------+
```

A difference with respect to Stata's 'ppmlhdfe' is that capybara requires an explicit cluster term in the formula
to compute robust standard errors using a sandwich operation.

```{r fe1-capybara-2}
ppmlhdfe$fe1$pair <- paste0(ppmlhdfe$fe1$i, ppmlhdfe$fe1$j)

fepoisson(
  y ~ x1 + x2 | i + j | pair,
  data = ppmlhdfe$fe1
)
```

Other R packages may not detect separation in Poisson models with fixed effects. By disabling the separation check in
Capybara, we can match 'alpaca' and 'fixest' results.

Capybara without checking separation (incorrect $\beta_2$):

```{r fe-capybara-3}
fepoisson(
  y ~ x1 + x2 | i + j,
  data = ppmlhdfe$fe1,
  control = list(check_separation = FALSE)
)
```

Alpaca:

```{r fe-alpaca, eval = FALSE}
alpaca::feglm(
  y ~ x1 + x2 | i + j,
  data = ppmlhdfe$fe1,
  family = poisson()
)
```

```r
poisson - log link, l= [4, 4]

      x1       x2 
 -0.4845 -17.3711 
```

Fixest:

```{r fe-fixest, eval = FALSE}
fixest::feglm(
  y ~ x1 + x2 | i + j,
  data = ppmlhdfe$fe1,
  family = poisson()
)
```

```r
GLM estimation, family = poisson, Dep. Var.: y
Observations: 18
Fixed-effects: i: 4,  j: 4
Standard-errors: IID 
     Estimate Std. Error   z value Pr(>|z|) 
x1  -0.484547    1.70957 -0.283432  0.77685 
x2 -18.514805 6880.80328 -0.002691  0.99785 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
Log-Likelihood: -12.3   Adj. Pseudo R2: -0.353285
           BIC:  50.6     Squared Cor.:  0.261426
```
